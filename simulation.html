<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Soccer Predictions Using Bayesian Mixed Effects Models</title>
  <meta name="description" content="A tutorial for creating a ranking system for soccer teams and making predictions.">
  <meta name="generator" content="bookdown 0.3.19 and GitBook 2.6.7">

  <meta property="og:title" content="Soccer Predictions Using Bayesian Mixed Effects Models" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A tutorial for creating a ranking system for soccer teams and making predictions." />
  <meta name="github-repo" content="wjakethompson/soccer" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Soccer Predictions Using Bayesian Mixed Effects Models" />
  <meta name="twitter:site" content="@wjakethompson" />
  <meta name="twitter:description" content="A tutorial for creating a ranking system for soccer teams and making predictions." />
  

<meta name="author" content="Jake Thompson">


<meta name="date" content="2017-05-04">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="define-model.html">
<link rel="next" href="gather-data.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-0.8/htmlwidgets.js"></script>
<script src="libs/datatables-binding-0.2/datatables.js"></script>
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.12/js/jquery.dataTables.min.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><strong><a href="./">Soccer Predictions</a></strong></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#european-soccer-format"><i class="fa fa-check"></i><b>1.1</b> European soccer format</a><ul>
<li class="chapter" data-level="1.1.1" data-path="intro.html"><a href="intro.html#dom-league-descrip"><i class="fa fa-check"></i><b>1.1.1</b> Domestic leagues</a></li>
<li class="chapter" data-level="1.1.2" data-path="intro.html"><a href="intro.html#domestic-cups"><i class="fa fa-check"></i><b>1.1.2</b> Domestic cups</a></li>
<li class="chapter" data-level="1.1.3" data-path="intro.html"><a href="intro.html#fifa-and-uefa-competitions"><i class="fa fa-check"></i><b>1.1.3</b> FIFA and UEFA Competitions</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#document-organization"><i class="fa fa-check"></i><b>1.2</b> Document organization</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#colophon"><i class="fa fa-check"></i><b>1.3</b> Colophon</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="define-model.html"><a href="define-model.html"><i class="fa fa-check"></i><b>2</b> Defining the Model</a><ul>
<li class="chapter" data-level="2.1" data-path="define-model.html"><a href="define-model.html#biv-pois"><i class="fa fa-check"></i><b>2.1</b> The bivariate Poisson model</a><ul>
<li class="chapter" data-level="2.1.1" data-path="define-model.html"><a href="define-model.html#imp-bivpois"><i class="fa fa-check"></i><b>2.1.1</b> Implementing the bivariate Poisson model</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="define-model.html"><a href="define-model.html#gri"><i class="fa fa-check"></i><b>2.2</b> The game random intercept model</a><ul>
<li class="chapter" data-level="2.2.1" data-path="define-model.html"><a href="define-model.html#imp-gri"><i class="fa fa-check"></i><b>2.2.1</b> Implementing the game random intercept model</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="simulation.html"><a href="simulation.html"><i class="fa fa-check"></i><b>3</b> Simulation Study</a><ul>
<li class="chapter" data-level="3.1" data-path="simulation.html"><a href="simulation.html#data-generation"><i class="fa fa-check"></i><b>3.1</b> Data generation</a></li>
<li class="chapter" data-level="3.2" data-path="simulation.html"><a href="simulation.html#model-est"><i class="fa fa-check"></i><b>3.2</b> Model estimation</a></li>
<li class="chapter" data-level="3.3" data-path="simulation.html"><a href="simulation.html#running-the-simulation"><i class="fa fa-check"></i><b>3.3</b> Running the simulation</a></li>
<li class="chapter" data-level="3.4" data-path="simulation.html"><a href="simulation.html#sim-results"><i class="fa fa-check"></i><b>3.4</b> Simulation results</a><ul>
<li class="chapter" data-level="3.4.1" data-path="simulation.html"><a href="simulation.html#sim-corr"><i class="fa fa-check"></i><b>3.4.1</b> Correlation between true and estimated parameters</a></li>
<li class="chapter" data-level="3.4.2" data-path="simulation.html"><a href="simulation.html#sim-bias-mse"><i class="fa fa-check"></i><b>3.4.2</b> Estimation bias and mean square error</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="simulation.html"><a href="simulation.html#sim-concl"><i class="fa fa-check"></i><b>3.5</b> Summary of findings</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="gather-data.html"><a href="gather-data.html"><i class="fa fa-check"></i><b>4</b> Gather Data</a><ul>
<li class="chapter" data-level="4.1" data-path="gather-data.html"><a href="gather-data.html#domestic-league-inclusion"><i class="fa fa-check"></i><b>4.1</b> Domestic league inclusion</a></li>
<li class="chapter" data-level="4.2" data-path="gather-data.html"><a href="gather-data.html#non-domestic-competition-inclusion"><i class="fa fa-check"></i><b>4.2</b> Non-domestic competition inclusion</a></li>
<li class="chapter" data-level="4.3" data-path="gather-data.html"><a href="gather-data.html#domestic-competition-inclusion"><i class="fa fa-check"></i><b>4.3</b> Domestic competition inclusion</a></li>
<li class="chapter" data-level="4.4" data-path="gather-data.html"><a href="gather-data.html#collect-club-websites"><i class="fa fa-check"></i><b>4.4</b> Collect club websites</a></li>
<li class="chapter" data-level="4.5" data-path="gather-data.html"><a href="gather-data.html#scrape-game-data"><i class="fa fa-check"></i><b>4.5</b> Scrape game data</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="fit-model.html"><a href="fit-model.html"><i class="fa fa-check"></i><b>5</b> Fitting the Model</a><ul>
<li class="chapter" data-level="5.1" data-path="fit-model.html"><a href="fit-model.html#fit-real-data"><i class="fa fa-check"></i><b>5.1</b> Model estimation</a></li>
<li class="chapter" data-level="5.2" data-path="fit-model.html"><a href="fit-model.html#diagnostics"><i class="fa fa-check"></i><b>5.2</b> MCMC diagnostics</a><ul>
<li class="chapter" data-level="5.2.1" data-path="fit-model.html"><a href="fit-model.html#convergence"><i class="fa fa-check"></i><b>5.2.1</b> Convergence</a></li>
<li class="chapter" data-level="5.2.2" data-path="fit-model.html"><a href="fit-model.html#efficiency"><i class="fa fa-check"></i><b>5.2.2</b> Efficiency</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="fit-model.html"><a href="fit-model.html#model-fit"><i class="fa fa-check"></i><b>5.3</b> Model fit</a><ul>
<li class="chapter" data-level="5.3.1" data-path="fit-model.html"><a href="fit-model.html#ppmc-score-dist"><i class="fa fa-check"></i><b>5.3.1</b> Score distributions</a></li>
<li class="chapter" data-level="5.3.2" data-path="fit-model.html"><a href="fit-model.html#ppmc-mov-int"><i class="fa fa-check"></i><b>5.3.2</b> Margin of victory intervals</a></li>
<li class="chapter" data-level="5.3.3" data-path="fit-model.html"><a href="fit-model.html#ppmc-prediction"><i class="fa fa-check"></i><b>5.3.3</b> Prediction error</a></li>
<li class="chapter" data-level="5.3.4" data-path="fit-model.html"><a href="fit-model.html#posterior-predictive-check-summary"><i class="fa fa-check"></i><b>5.3.4</b> Posterior predictive check summary</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="fit-model.html"><a href="fit-model.html#results"><i class="fa fa-check"></i><b>5.4</b> Results</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="predict.html"><a href="predict.html"><i class="fa fa-check"></i><b>6</b> Making Predictions</a><ul>
<li class="chapter" data-level="6.1" data-path="predict.html"><a href="predict.html#predict-individual-games"><i class="fa fa-check"></i><b>6.1</b> Predict individual games</a></li>
<li class="chapter" data-level="6.2" data-path="predict.html"><a href="predict.html#predict-domestic-leagues"><i class="fa fa-check"></i><b>6.2</b> Predict domestic leagues</a><ul>
<li class="chapter" data-level="6.2.1" data-path="predict.html"><a href="predict.html#epl"><i class="fa fa-check"></i><b>6.2.1</b> English Premier League</a></li>
<li class="chapter" data-level="6.2.2" data-path="predict.html"><a href="predict.html#ligue1"><i class="fa fa-check"></i><b>6.2.2</b> French Ligue 1</a></li>
<li class="chapter" data-level="6.2.3" data-path="predict.html"><a href="predict.html#bund"><i class="fa fa-check"></i><b>6.2.3</b> German Bundesliga</a></li>
<li class="chapter" data-level="6.2.4" data-path="predict.html"><a href="predict.html#seriea"><i class="fa fa-check"></i><b>6.2.4</b> Italian Serie A</a></li>
<li class="chapter" data-level="6.2.5" data-path="predict.html"><a href="predict.html#laliga"><i class="fa fa-check"></i><b>6.2.5</b> Spanish La Liga</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="predict.html"><a href="predict.html#uefa-champions-league"><i class="fa fa-check"></i><b>6.3</b> UEFA Champions League</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="conclusion.html"><a href="conclusion.html"><i class="fa fa-check"></i><b>7</b> Conclusion</a><ul>
<li class="chapter" data-level="7.1" data-path="conclusion.html"><a href="conclusion.html#limitations-and-future-directions"><i class="fa fa-check"></i><b>7.1</b> Limitations and future directions</a></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="simulation-functions.html"><a href="simulation-functions.html"><i class="fa fa-check"></i><b>A</b> Simulation Functions</a><ul>
<li class="chapter" data-level="A.1" data-path="simulation-functions.html"><a href="simulation-functions.html#bivpois-generate"><i class="fa fa-check"></i><b>A.1</b> Generate bivariate Poisson</a></li>
<li class="chapter" data-level="A.2" data-path="simulation-functions.html"><a href="simulation-functions.html#gri-generate"><i class="fa fa-check"></i><b>A.2</b> Generate game random intercept</a></li>
<li class="chapter" data-level="A.3" data-path="simulation-functions.html"><a href="simulation-functions.html#estimate-fun"><i class="fa fa-check"></i><b>A.3</b> Fit models to simualted data</a></li>
<li class="chapter" data-level="A.4" data-path="simulation-functions.html"><a href="simulation-functions.html#ggally-cor"><i class="fa fa-check"></i><b>A.4</b> Plot correlation matrices</a><ul>
<li class="chapter" data-level="A.4.1" data-path="simulation-functions.html"><a href="simulation-functions.html#ggally-comp"><i class="fa fa-check"></i><b>A.4.1</b> Plot components</a></li>
<li class="chapter" data-level="A.4.2" data-path="simulation-functions.html"><a href="simulation-functions.html#ggally-plot"><i class="fa fa-check"></i><b>A.4.2</b> Plot creation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="B" data-path="scrape-functions.html"><a href="scrape-functions.html"><i class="fa fa-check"></i><b>B</b> Web Scraping Functions</a><ul>
<li class="chapter" data-level="B.1" data-path="scrape-functions.html"><a href="scrape-functions.html#league-scrape"><i class="fa fa-check"></i><b>B.1</b> Scrape league pages</a></li>
<li class="chapter" data-level="B.2" data-path="scrape-functions.html"><a href="scrape-functions.html#cup-scrape"><i class="fa fa-check"></i><b>B.2</b> Scrape international cups</a></li>
<li class="chapter" data-level="B.3" data-path="scrape-functions.html"><a href="scrape-functions.html#dom-scrape"><i class="fa fa-check"></i><b>B.3</b> Scrape domestic cups</a></li>
<li class="chapter" data-level="B.4" data-path="scrape-functions.html"><a href="scrape-functions.html#game-scrape"><i class="fa fa-check"></i><b>B.4</b> Scrape games</a></li>
</ul></li>
<li class="chapter" data-level="C" data-path="diagnostic-output.html"><a href="diagnostic-output.html"><i class="fa fa-check"></i><b>C</b> Model Diagnostics Output</a><ul>
<li class="chapter" data-level="C.1" data-path="diagnostic-output.html"><a href="diagnostic-output.html#rhat-plot"><i class="fa fa-check"></i><b>C.1</b> Plot <span class="math inline">\(\hat{R}\)</span> values</a></li>
<li class="chapter" data-level="C.2" data-path="diagnostic-output.html"><a href="diagnostic-output.html#plot-effective-sample-size-values"><i class="fa fa-check"></i><b>C.2</b> Plot effective sample size values</a></li>
<li class="chapter" data-level="C.3" data-path="diagnostic-output.html"><a href="diagnostic-output.html#nuts-diagnostics-table"><i class="fa fa-check"></i><b>C.3</b> NUTS diagnostics table</a></li>
<li class="chapter" data-level="C.4" data-path="diagnostic-output.html"><a href="diagnostic-output.html#ppmc-sdp"><i class="fa fa-check"></i><b>C.4</b> PPMC score distribution plot</a></li>
<li class="chapter" data-level="C.5" data-path="diagnostic-output.html"><a href="diagnostic-output.html#ppmc-mov"><i class="fa fa-check"></i><b>C.5</b> PPMC margin of victory credible intervals</a></li>
<li class="chapter" data-level="C.6" data-path="diagnostic-output.html"><a href="diagnostic-output.html#log-loss-comparison-table"><i class="fa fa-check"></i><b>C.6</b> Log loss comparison table</a></li>
</ul></li>
<li class="chapter" data-level="D" data-path="prediction-functions.html"><a href="prediction-functions.html"><i class="fa fa-check"></i><b>D</b> Prediction Functions</a><ul>
<li class="chapter" data-level="D.1" data-path="prediction-functions.html"><a href="prediction-functions.html#predict-game"><i class="fa fa-check"></i><b>D.1</b> Predict individual games</a></li>
<li class="chapter" data-level="D.2" data-path="prediction-functions.html"><a href="prediction-functions.html#multi-plot"><i class="fa fa-check"></i><b>D.2</b> Plot multiple plots</a></li>
<li class="chapter" data-level="D.3" data-path="prediction-functions.html"><a href="prediction-functions.html#predict-league"><i class="fa fa-check"></i><b>D.3</b> Predict leagues</a></li>
<li class="chapter" data-level="D.4" data-path="prediction-functions.html"><a href="prediction-functions.html#predict-ucl"><i class="fa fa-check"></i><b>D.4</b> Predict Champions League</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Soccer Predictions Using Bayesian Mixed Effects Models</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="simulation" class="section level1">
<h1><span class="header-section-number">3</span> Simulation Study</h1>
<p>In order to evaluate these two models, I conducted a small scale simulation study. I generated 100 data sets from each of the bivariate Poisson and game random intercept models (for 200 data sets total). For each data set, both of the models were estimated to determine how well they were able to recover the attacking and defensive parameters for each team when the data generating model did and did not match the model.</p>
<div id="data-generation" class="section level2">
<h2><span class="header-section-number">3.1</span> Data generation</h2>
<p>Data was simulated to mimic the major domestic European leagues. For each data set, 20 clubs were generated, with each club playing all other clubs twice, once at home, and once away, for a total of 380 games.</p>
<p>For both data generating models, <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\delta\)</span> parameters were drawn from a <span class="math inline">\(\mathcal{N}(0,0.35)\)</span>. Both <span class="math inline">\(\rho\)</span> in the bivariate Poisson and <span class="math inline">\(\gamma\)</span> in the game random intercept model were sampled from a <span class="math inline">\(\mathcal{N}(0,0.1)\)</span> distribution. For all models, <span class="math inline">\(\mu\)</span> was set to 0, and <span class="math inline">\(\eta\)</span> was set to 0.5. These distributions were based on preliminary analyses using the 2015-16 English Premier League data.</p>
<p>For each game, <span class="math inline">\(\lambda\)</span> values were calculated based on the parameters that were generated for each team (and game for the game random intercept model). Scores were then randomly generated using the <code>rpois()</code> function. Full data generation functions can be see in Appendix <a href="simulation-functions.html#bivpois-generate">A.1</a> and <a href="simulation-functions.html#gri-generate">A.2</a>. When simulating the data sets, the <strong>portableParallelSeeds</strong> package was used to ensure that the data generation was completely replicable, and that the random number streams were not overlapping <span class="citation">(P. E. Johnson, 2016)</span>.</p>
</div>
<div id="model-est" class="section level2">
<h2><span class="header-section-number">3.2</span> Model estimation</h2>
<p>In total, 200 data sets were generated: 100 from the bivariate Poisson, and 100 from the game random intercept model. For each data set, both the bivariate Poisson and game random intercept model were estimated. Thus, each model was estimated 100 times on a data set from the matching data generation method, and 100 times on mismatched data.</p>
<p>For each estimation, 2 chains were run with 15000 iterations. The first 5000 iterations of each chain were discarded for burn-in. This resulted in a total of 20000 retained iterations that made up the final posterior distributions. The thinning interval was set to 1 (no thinning). Finally, the target proposal acceptance rate during the adaptation period was set to 0.99. This forces the algorithm to take smaller steps, which decreases efficiency. However, this also helps to eliminate divergent transitions, which are common when parameter estimates are close to their bounds, such as a variance very close to 0 <span class="citation">(Stan Development Team, 2016c, 2016a)</span>. The full model estimation function can be seen in Appendix <a href="simulation-functions.html#estimate-fun">A.3</a>.</p>
</div>
<div id="running-the-simulation" class="section level2">
<h2><span class="header-section-number">3.3</span> Running the simulation</h2>
<p>The following code was used to run the simulation. I first define the total number of replications and the number of random streams needed for each replication. I then use <strong>portableParallelSeeds</strong> <span class="citation">(P. E. Johnson, 2016)</span> to create seeds for each replication, and save them. Data sets are then generated from each model, with the number of data sets from each model being equal to half of the total number of replications specified by <code>n_reps</code>. Finally, I create one list that contains all of the data sets, <code>simulation_data</code>, and map the simulation function to each element of that list using the <strong>purrr</strong> package <span class="citation">(Wickham, 2016b)</span>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Define parameters for the simulation</span>
n_reps &lt;-<span class="st"> </span><span class="dv">200</span>
streams_per_rep &lt;-<span class="st"> </span><span class="dv">1</span>

<span class="co"># Create the seed warehouse</span>
project_seeds &lt;-<span class="st"> </span><span class="kw">seedCreator</span>(n_reps, streams_per_rep, <span class="dt">seed =</span> <span class="dv">9416</span>)
<span class="kw">save</span>(project_seeds, <span class="dt">file =</span> <span class="st">&quot;_data/simulation_seeds.rda&quot;</span>)

<span class="co"># Create data sets</span>
bivpois_data &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dt">X =</span> <span class="dv">1</span>:(n_reps /<span class="st"> </span><span class="dv">2</span>), <span class="dt">FUN =</span> generate_bivpois,
  <span class="dt">seeds =</span> project_seeds, <span class="dt">num_club =</span> <span class="dv">20</span>)
gri_data &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dt">X =</span> ((n_reps /<span class="st"> </span><span class="dv">2</span>) +<span class="st"> </span><span class="dv">1</span>):n_reps, <span class="dt">FUN =</span> generate_gri,
  <span class="dt">seeds =</span> project_seeds, <span class="dt">num_club =</span> <span class="dv">20</span>)

simulation_data &lt;-<span class="st"> </span><span class="kw">c</span>(
  bivpois_data,
  gri_data
)

simulation &lt;-<span class="st"> </span><span class="kw">map_df</span>(<span class="dt">.x =</span> simulation_data, <span class="dt">.f =</span> simulation_fun)
<span class="kw">save</span>(simulation, <span class="dt">file =</span> <span class="st">&quot;_data/simulation.rda&quot;</span>)</code></pre></div>
</div>
<div id="sim-results" class="section level2">
<h2><span class="header-section-number">3.4</span> Simulation results</h2>
<div id="sim-corr" class="section level3">
<h3><span class="header-section-number">3.4.1</span> Correlation between true and estimated parameters</h3>
<p>To assess the bivariate Poisson and game random intercept models, I first examine the correlations between the true parameters and the estimated parameters from each model. The parameters for each replication can be pulled out of the simulation results using the <strong>purrr</strong> and <strong>dplyr</strong> packages <span class="citation">(Wickham, 2016b; Wickham &amp; Francois, 2016)</span>. The <strong>plyr</strong> package will be used later but, for compatibility reasons, needs to be loaded before <strong>dplyr</strong>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(plyr)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(purrr)

plot_sim &lt;-<span class="st"> </span>simulation %&gt;%
<span class="st">  </span><span class="kw">select</span>(generator, true_params, bivpois_params, gri_params) %&gt;%
<span class="st">  </span><span class="kw">as.list</span>() %&gt;%
<span class="st">  </span><span class="kw">pmap_df</span>(<span class="dt">.l =</span> ., <span class="dt">.f =</span> function(generator, true_params, bivpois_params,
    gri_params) {
      <span class="kw">data_frame</span>(
        <span class="dt">generator =</span> generator,
        <span class="dt">true_alpha =</span> true_params$attack,
        <span class="dt">true_delta =</span> true_params$defend,
        <span class="dt">bivpois_alpha =</span> bivpois_params$bivpois_alpha,
        <span class="dt">bivpois_delta =</span> bivpois_params$bivpois_delta,
        <span class="dt">gri_alpha =</span> gri_params$gri_alpha,
        <span class="dt">gri_delta =</span> gri_params$gri_delta
      )
    })</code></pre></div>
<p>I then use the <strong>GGally</strong> package <span class="citation">(Schloerke et al., 2016)</span>, an extension of <strong>ggplot2</strong> <span class="citation">(Wickham &amp; Chang, 2016)</span> to plot a scatter plot matrix with correlations. I use the <code>round_any()</code> function from the <strong>plyr</strong> package <span class="citation">(Wickham, 2016a)</span> to set the limits on the axes. The functions to create the lower and upper triangles and the diagonal of the scatter plot matrix (<code>lowerFn()</code>, <code>upperFn()</code>, and <code>diagFn()</code> respectively) can be found in Appendix <a href="simulation-functions.html#ggally-comp">A.4.1</a>, and the code to put the plots together can be found in Appendix <a href="simulation-functions.html#ggally-plot">A.4.2</a>.</p>
<div class="figure" style="text-align: center"><span id="fig:alpha-cor"></span>
<img src="simulation_files/figure-html/alpha-cor-1.png" alt="Correlation between true and estimated alpha parameters under different generating and estimated models." width="80%" />
<p class="caption">
Figure 3.1: Correlation between true and estimated alpha parameters under different generating and estimated models.
</p>
</div>
<div class="figure" style="text-align: center"><span id="fig:delta-cor"></span>
<img src="simulation_files/figure-html/delta-cor-1.png" alt="Correlation between true and estimated delta parameters under different generating and estimated models." width="80%" />
<p class="caption">
Figure 3.2: Correlation between true and estimated delta parameters under different generating and estimated models.
</p>
</div>
<p>In the Figures <a href="simulation.html#fig:alpha-cor">3.1</a> and <a href="simulation.html#fig:delta-cor">3.2</a>, the margins show which model was estimated. The upper triangle shows the correlations between the estimated parameters for the model and the true parameters under each of the data generation conditions. For example, when estimating the alpha parameters with the bivariate Poisson (Figure <a href="simulation.html#fig:alpha-cor">3.1</a>), the correlation between estimated parameters and true parameters is 0.831 when the data was generated with the GRI model and 0.832 when generated with the bivariate Poisson model.</p>
<p>When looking at Figures <a href="simulation.html#fig:alpha-cor">3.1</a> and <a href="simulation.html#fig:delta-cor">3.2</a>, the correlation between true and estimated parameters is higher when the game random intercept model is used for estimation compared to the bivariate Poisson. This is true when the game random intercept model is used to generate data (0.907 to 0.831 for alpha and 0.903 to 0.821 for delta) and when the bivariate Poisson model is use for data generation (0.847 to 0.832 for alpha and 0.861 to 0.849 for delta). Thus, this provides preliminary evidence that the game random intercept model should be preferred.</p>
</div>
<div id="sim-bias-mse" class="section level3">
<h3><span class="header-section-number">3.4.2</span> Estimation bias and mean square error</h3>
<p>It is also useful to look at the average bias and mean squared error of the estimates from each model. Table <a href="simulation.html#tab:bias-table">3.1</a> shows the average bias in the estimates for alpha and delta (calculated as <span class="math inline">\(estimate - true\)</span>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">simulation %&gt;%
<span class="st">  </span><span class="kw">select</span>(<span class="st">`</span><span class="dt">Data Generator</span><span class="st">`</span> =<span class="st"> </span>generator, bivpois_alpha_bias, bivpois_delta_bias,
    gri_alpha_bias, gri_delta_bias) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(<span class="st">`</span><span class="dt">Data Generator</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(
    <span class="st">`</span><span class="dt">Bivariate Poisson: Alpha</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%.3f&quot;</span>, <span class="kw">mean</span>(bivpois_alpha_bias)),
    <span class="st">`</span><span class="dt">Bivariate Poisson: Delta</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%.3f&quot;</span>, <span class="kw">mean</span>(bivpois_delta_bias)),
    <span class="st">`</span><span class="dt">Game Random Intercept: Alpha</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%.3f&quot;</span>, <span class="kw">mean</span>(gri_alpha_bias)),
    <span class="st">`</span><span class="dt">Game Random Intercept: Delta</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%.3f&quot;</span>, <span class="kw">mean</span>(gri_delta_bias))
  ) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">Data Generator</span><span class="st">`</span> =<span class="st"> </span><span class="kw">factor</span>(<span class="st">`</span><span class="dt">Data Generator</span><span class="st">`</span>, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;bivpois&quot;</span>, <span class="st">&quot;gri&quot;</span>),
    <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;Bivariate Poisson&quot;</span>, <span class="st">&quot;Game Random Intercept&quot;</span>))) %&gt;%
<span class="st">  </span>knitr::<span class="kw">kable</span>(<span class="dt">caption =</span> <span class="st">&quot;Estimation bias for alpha and delta parameters.&quot;</span>)</code></pre></div>
<table>
<caption><span id="tab:bias-table">Table 3.1: </span>Estimation bias for alpha and delta parameters.</caption>
<thead>
<tr class="header">
<th align="left">Data Generator</th>
<th align="left">Bivariate Poisson: Alpha</th>
<th align="left">Bivariate Poisson: Delta</th>
<th align="left">Game Random Intercept: Alpha</th>
<th align="left">Game Random Intercept: Delta</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Bivariate Poisson</td>
<td align="left">0.001</td>
<td align="left">-0.012</td>
<td align="left">0.001</td>
<td align="left">-0.012</td>
</tr>
<tr class="even">
<td align="left">Game Random Intercept</td>
<td align="left">-0.010</td>
<td align="left">-0.003</td>
<td align="left">-0.010</td>
<td align="left">-0.002</td>
</tr>
</tbody>
</table>
<p>The bias is nearly identical across estimation models, regardless of which model was used for data generation. Further, all of the biases are very close to 0, indicating that neither model significantly biases the estimates in a positive or negative way.</p>
<p>Table <a href="simulation.html#tab:mse-table">3.2</a> shows the average mean square error in the estimates for alpha and delta (calculated as <span class="math inline">\((estimate - true)^2\)</span>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">simulation %&gt;%
<span class="st">  </span><span class="kw">select</span>(<span class="st">`</span><span class="dt">Data Generator</span><span class="st">`</span> =<span class="st"> </span>generator, bivpois_alpha_mse, bivpois_delta_mse,
    gri_alpha_mse, gri_delta_mse) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(<span class="st">`</span><span class="dt">Data Generator</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(
    <span class="st">`</span><span class="dt">Bivariate Poisson: Alpha</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%.3f&quot;</span>, <span class="kw">mean</span>(bivpois_alpha_mse)),
    <span class="st">`</span><span class="dt">Bivariate Poisson: Delta</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%.3f&quot;</span>, <span class="kw">mean</span>(bivpois_delta_mse)),
    <span class="st">`</span><span class="dt">Game Random Intercept: Alpha</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%.3f&quot;</span>, <span class="kw">mean</span>(gri_alpha_mse)),
    <span class="st">`</span><span class="dt">Game Random Intercept: Delta</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%.3f&quot;</span>, <span class="kw">mean</span>(gri_delta_mse))
  ) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">Data Generator</span><span class="st">`</span> =<span class="st"> </span><span class="kw">factor</span>(<span class="st">`</span><span class="dt">Data Generator</span><span class="st">`</span>, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;bivpois&quot;</span>, <span class="st">&quot;gri&quot;</span>),
    <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;Bivariate Poisson&quot;</span>, <span class="st">&quot;Game Random Intercept&quot;</span>))) %&gt;%
<span class="st">  </span>knitr::<span class="kw">kable</span>(<span class="dt">caption =</span> <span class="st">&quot;Estimation mean square error for alpha and delta parameters.&quot;</span>)</code></pre></div>
<table>
<caption><span id="tab:mse-table">Table 3.2: </span>Estimation mean square error for alpha and delta parameters.</caption>
<thead>
<tr class="header">
<th align="left">Data Generator</th>
<th align="left">Bivariate Poisson: Alpha</th>
<th align="left">Bivariate Poisson: Delta</th>
<th align="left">Game Random Intercept: Alpha</th>
<th align="left">Game Random Intercept: Delta</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Bivariate Poisson</td>
<td align="left">0.038</td>
<td align="left">0.037</td>
<td align="left">0.046</td>
<td align="left">0.049</td>
</tr>
<tr class="even">
<td align="left">Game Random Intercept</td>
<td align="left">0.083</td>
<td align="left">0.069</td>
<td align="left">0.022</td>
<td align="left">0.022</td>
</tr>
</tbody>
</table>
<p>As would be expected, there is more error associated with estimates coming from a model that doesn’t match the data generating model. However, comparatively, there is less error associated with the game random intercept model. When the estimation model matches the generation model, the game random intercept model has mean square error values of 0.022 and 0.022 for alpha and delta parameters respectively. The bivariate Poisson model has mean square error values of 0.038 and 0.037 for these same parameters. Similarly, the game random intercept model also shows lower error when the estimation model doesn’t match the generation model. The game random intercept model has mean square error values for alpha and delta of 0.046 and 0.049 when the bivariate Poisson generated the data, whereas the bivariate Poisson has mean square error values for alpha and delta of 0.083 and 0.069 when the game random intercept model generated the data.</p>
<p>These results indicate that the best choice of model would be the one that matches the data generation process. Unfortunately, when using real data, the exact data generation process is impossible to know. However, these findings also show that the cost of being wrong is much less when using the game random intercept model to estimate, compared to the bivariate Poisson model.</p>
</div>
</div>
<div id="sim-concl" class="section level2">
<h2><span class="header-section-number">3.5</span> Summary of findings</h2>
<p>The findings from the simulation study indicate that the game random intercept model should be the preferred model for estimating the abilities of soccer teams. Across data generating models, the game random intercept model was better able to recover the true parameters (Section <a href="simulation.html#sim-corr">3.4.1</a>). Additionally, the game random intercept model had comparable bias and lower mean square error than the the bivariate Poisson model (Section <a href="simulation.html#sim-bias-mse">3.4.2</a>).</p>
<p>Therefore, I will be using the game random intercept model moving forward for estimating the model on real data and predicting future games.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="define-model.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="gather-data.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": true,
"weibo": false,
"instapper": false,
"vk": false,
"all": null
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/wjakethompson/soccer/edit/master/simulation.Rmd",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
