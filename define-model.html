<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Soccer Predictions Using Bayesian Mixed Effects Models</title>
  <meta name="description" content="A tutorial for creating a ranking system for soccer teams and making predictions.">
  <meta name="generator" content="bookdown 0.3.17 and GitBook 2.6.7">

  <meta property="og:title" content="Soccer Predictions Using Bayesian Mixed Effects Models" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A tutorial for creating a ranking system for soccer teams and making predictions." />
  <meta name="github-repo" content="wjakethompson/soccer" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Soccer Predictions Using Bayesian Mixed Effects Models" />
  <meta name="twitter:site" content="@wjakethompson" />
  <meta name="twitter:description" content="A tutorial for creating a ranking system for soccer teams and making predictions." />
  

<meta name="author" content="Jake Thompson">


<meta name="date" content="2017-04-11">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="intro.html">
<link rel="next" href="simulation.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-0.8/htmlwidgets.js"></script>
<script src="libs/datatables-binding-0.2/datatables.js"></script>
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.12/js/jquery.dataTables.min.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><strong><a href="./">Soccer Predictions</a></strong></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#european-soccer-format"><i class="fa fa-check"></i><b>1.1</b> European soccer format</a><ul>
<li class="chapter" data-level="1.1.1" data-path="intro.html"><a href="intro.html#dom-league-descrip"><i class="fa fa-check"></i><b>1.1.1</b> Domestic leagues</a></li>
<li class="chapter" data-level="1.1.2" data-path="intro.html"><a href="intro.html#domestic-cups"><i class="fa fa-check"></i><b>1.1.2</b> Domestic cups</a></li>
<li class="chapter" data-level="1.1.3" data-path="intro.html"><a href="intro.html#fifa-and-uefa-competitions"><i class="fa fa-check"></i><b>1.1.3</b> FIFA and UEFA Competitions</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#document-organization"><i class="fa fa-check"></i><b>1.2</b> Document organization</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#colophon"><i class="fa fa-check"></i><b>1.3</b> Colophon</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="define-model.html"><a href="define-model.html"><i class="fa fa-check"></i><b>2</b> Defining the Model</a><ul>
<li class="chapter" data-level="2.1" data-path="define-model.html"><a href="define-model.html#biv-pois"><i class="fa fa-check"></i><b>2.1</b> The bivariate Poisson model</a><ul>
<li class="chapter" data-level="2.1.1" data-path="define-model.html"><a href="define-model.html#imp-bivpois"><i class="fa fa-check"></i><b>2.1.1</b> Implementing the bivariate Poisson model</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="define-model.html"><a href="define-model.html#gri"><i class="fa fa-check"></i><b>2.2</b> The game random intercept model</a><ul>
<li class="chapter" data-level="2.2.1" data-path="define-model.html"><a href="define-model.html#imp-gri"><i class="fa fa-check"></i><b>2.2.1</b> Implementing the game random intercept model</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="simulation.html"><a href="simulation.html"><i class="fa fa-check"></i><b>3</b> Simulation Study</a><ul>
<li class="chapter" data-level="3.1" data-path="simulation.html"><a href="simulation.html#data-generation"><i class="fa fa-check"></i><b>3.1</b> Data generation</a></li>
<li class="chapter" data-level="3.2" data-path="simulation.html"><a href="simulation.html#model-est"><i class="fa fa-check"></i><b>3.2</b> Model estimation</a></li>
<li class="chapter" data-level="3.3" data-path="simulation.html"><a href="simulation.html#running-the-simulation"><i class="fa fa-check"></i><b>3.3</b> Running the simulation</a></li>
<li class="chapter" data-level="3.4" data-path="simulation.html"><a href="simulation.html#sim-results"><i class="fa fa-check"></i><b>3.4</b> Simulation results</a><ul>
<li class="chapter" data-level="3.4.1" data-path="simulation.html"><a href="simulation.html#sim-corr"><i class="fa fa-check"></i><b>3.4.1</b> Correlation between true and estimated parameters</a></li>
<li class="chapter" data-level="3.4.2" data-path="simulation.html"><a href="simulation.html#sim-bias-mse"><i class="fa fa-check"></i><b>3.4.2</b> Estimation bias and mean square error</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="simulation.html"><a href="simulation.html#sim-concl"><i class="fa fa-check"></i><b>3.5</b> Summary of findings</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="gather-data.html"><a href="gather-data.html"><i class="fa fa-check"></i><b>4</b> Gather Data</a><ul>
<li class="chapter" data-level="4.1" data-path="gather-data.html"><a href="gather-data.html#domestic-league-inclusion"><i class="fa fa-check"></i><b>4.1</b> Domestic league inclusion</a></li>
<li class="chapter" data-level="4.2" data-path="gather-data.html"><a href="gather-data.html#non-domestic-competition-inclusion"><i class="fa fa-check"></i><b>4.2</b> Non-domestic competition inclusion</a></li>
<li class="chapter" data-level="4.3" data-path="gather-data.html"><a href="gather-data.html#domestic-competition-inclusion"><i class="fa fa-check"></i><b>4.3</b> Domestic competition inclusion</a></li>
<li class="chapter" data-level="4.4" data-path="gather-data.html"><a href="gather-data.html#collect-club-websites"><i class="fa fa-check"></i><b>4.4</b> Collect club websites</a></li>
<li class="chapter" data-level="4.5" data-path="gather-data.html"><a href="gather-data.html#scrape-game-data"><i class="fa fa-check"></i><b>4.5</b> Scrape game data</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="fit-model.html"><a href="fit-model.html"><i class="fa fa-check"></i><b>5</b> Fitting the Model</a><ul>
<li class="chapter" data-level="5.1" data-path="fit-model.html"><a href="fit-model.html#fit-real-data"><i class="fa fa-check"></i><b>5.1</b> Model estimation</a></li>
<li class="chapter" data-level="5.2" data-path="fit-model.html"><a href="fit-model.html#diagnostics"><i class="fa fa-check"></i><b>5.2</b> MCMC diagnostics</a><ul>
<li class="chapter" data-level="5.2.1" data-path="fit-model.html"><a href="fit-model.html#convergence"><i class="fa fa-check"></i><b>5.2.1</b> Convergence</a></li>
<li class="chapter" data-level="5.2.2" data-path="fit-model.html"><a href="fit-model.html#efficiency"><i class="fa fa-check"></i><b>5.2.2</b> Efficiency</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="fit-model.html"><a href="fit-model.html#model-fit"><i class="fa fa-check"></i><b>5.3</b> Model fit</a><ul>
<li class="chapter" data-level="5.3.1" data-path="fit-model.html"><a href="fit-model.html#ppmc-score-dist"><i class="fa fa-check"></i><b>5.3.1</b> Score distributions</a></li>
<li class="chapter" data-level="5.3.2" data-path="fit-model.html"><a href="fit-model.html#ppmc-mov-int"><i class="fa fa-check"></i><b>5.3.2</b> Margin of victory intervals</a></li>
<li class="chapter" data-level="5.3.3" data-path="fit-model.html"><a href="fit-model.html#ppmc-prediction"><i class="fa fa-check"></i><b>5.3.3</b> Prediction error</a></li>
<li class="chapter" data-level="5.3.4" data-path="fit-model.html"><a href="fit-model.html#posterior-predictive-check-summary"><i class="fa fa-check"></i><b>5.3.4</b> Posterior predictive check summary</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="fit-model.html"><a href="fit-model.html#results"><i class="fa fa-check"></i><b>5.4</b> Results</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="predict.html"><a href="predict.html"><i class="fa fa-check"></i><b>6</b> Making Predictions</a><ul>
<li class="chapter" data-level="6.1" data-path="predict.html"><a href="predict.html#predict-individual-games"><i class="fa fa-check"></i><b>6.1</b> Predict individual games</a></li>
<li class="chapter" data-level="6.2" data-path="predict.html"><a href="predict.html#predict-domestic-leagues"><i class="fa fa-check"></i><b>6.2</b> Predict domestic leagues</a><ul>
<li class="chapter" data-level="6.2.1" data-path="predict.html"><a href="predict.html#epl"><i class="fa fa-check"></i><b>6.2.1</b> English Premier League</a></li>
<li class="chapter" data-level="6.2.2" data-path="predict.html"><a href="predict.html#ligue1"><i class="fa fa-check"></i><b>6.2.2</b> French Ligue 1</a></li>
<li class="chapter" data-level="6.2.3" data-path="predict.html"><a href="predict.html#bund"><i class="fa fa-check"></i><b>6.2.3</b> German Bundesliga</a></li>
<li class="chapter" data-level="6.2.4" data-path="predict.html"><a href="predict.html#seriea"><i class="fa fa-check"></i><b>6.2.4</b> Italian Serie A</a></li>
<li class="chapter" data-level="6.2.5" data-path="predict.html"><a href="predict.html#laliga"><i class="fa fa-check"></i><b>6.2.5</b> Spanish La Liga</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="predict.html"><a href="predict.html#uefa-champions-league"><i class="fa fa-check"></i><b>6.3</b> UEFA Champions League</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="conclusion.html"><a href="conclusion.html"><i class="fa fa-check"></i><b>7</b> Conclusion</a><ul>
<li class="chapter" data-level="7.1" data-path="conclusion.html"><a href="conclusion.html#limitations-and-future-directions"><i class="fa fa-check"></i><b>7.1</b> Limitations and future directions</a></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="simulation-functions.html"><a href="simulation-functions.html"><i class="fa fa-check"></i><b>A</b> Simulation Functions</a><ul>
<li class="chapter" data-level="A.1" data-path="simulation-functions.html"><a href="simulation-functions.html#bivpois-generate"><i class="fa fa-check"></i><b>A.1</b> Generate bivariate Poisson</a></li>
<li class="chapter" data-level="A.2" data-path="simulation-functions.html"><a href="simulation-functions.html#gri-generate"><i class="fa fa-check"></i><b>A.2</b> Generate game random intercept</a></li>
<li class="chapter" data-level="A.3" data-path="simulation-functions.html"><a href="simulation-functions.html#estimate-fun"><i class="fa fa-check"></i><b>A.3</b> Fit models to simualted data</a></li>
<li class="chapter" data-level="A.4" data-path="simulation-functions.html"><a href="simulation-functions.html#ggally-cor"><i class="fa fa-check"></i><b>A.4</b> Plot correlation matrices</a><ul>
<li class="chapter" data-level="A.4.1" data-path="simulation-functions.html"><a href="simulation-functions.html#ggally-comp"><i class="fa fa-check"></i><b>A.4.1</b> Plot components</a></li>
<li class="chapter" data-level="A.4.2" data-path="simulation-functions.html"><a href="simulation-functions.html#ggally-plot"><i class="fa fa-check"></i><b>A.4.2</b> Plot creation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="B" data-path="scrape-functions.html"><a href="scrape-functions.html"><i class="fa fa-check"></i><b>B</b> Web Scraping Functions</a><ul>
<li class="chapter" data-level="B.1" data-path="scrape-functions.html"><a href="scrape-functions.html#league-scrape"><i class="fa fa-check"></i><b>B.1</b> Scrape league pages</a></li>
<li class="chapter" data-level="B.2" data-path="scrape-functions.html"><a href="scrape-functions.html#cup-scrape"><i class="fa fa-check"></i><b>B.2</b> Scrape international cups</a></li>
<li class="chapter" data-level="B.3" data-path="scrape-functions.html"><a href="scrape-functions.html#dom-scrape"><i class="fa fa-check"></i><b>B.3</b> Scrape domestic cups</a></li>
<li class="chapter" data-level="B.4" data-path="scrape-functions.html"><a href="scrape-functions.html#game-scrape"><i class="fa fa-check"></i><b>B.4</b> Scrape games</a></li>
</ul></li>
<li class="chapter" data-level="C" data-path="diagnostic-output.html"><a href="diagnostic-output.html"><i class="fa fa-check"></i><b>C</b> Model Diagnostics Output</a><ul>
<li class="chapter" data-level="C.1" data-path="diagnostic-output.html"><a href="diagnostic-output.html#rhat-plot"><i class="fa fa-check"></i><b>C.1</b> Plot <span class="math inline">\(\hat{R}\)</span> values</a></li>
<li class="chapter" data-level="C.2" data-path="diagnostic-output.html"><a href="diagnostic-output.html#plot-effective-sample-size-values"><i class="fa fa-check"></i><b>C.2</b> Plot effective sample size values</a></li>
<li class="chapter" data-level="C.3" data-path="diagnostic-output.html"><a href="diagnostic-output.html#nuts-diagnostics-table"><i class="fa fa-check"></i><b>C.3</b> NUTS diagnostics table</a></li>
<li class="chapter" data-level="C.4" data-path="diagnostic-output.html"><a href="diagnostic-output.html#ppmc-sdp"><i class="fa fa-check"></i><b>C.4</b> PPMC score distribution plot</a></li>
<li class="chapter" data-level="C.5" data-path="diagnostic-output.html"><a href="diagnostic-output.html#ppmc-mov"><i class="fa fa-check"></i><b>C.5</b> PPMC margin of victory credible intervals</a></li>
<li class="chapter" data-level="C.6" data-path="diagnostic-output.html"><a href="diagnostic-output.html#log-loss-comparison-table"><i class="fa fa-check"></i><b>C.6</b> Log loss comparison table</a></li>
</ul></li>
<li class="chapter" data-level="D" data-path="prediction-functions.html"><a href="prediction-functions.html"><i class="fa fa-check"></i><b>D</b> Prediction Functions</a><ul>
<li class="chapter" data-level="D.1" data-path="prediction-functions.html"><a href="prediction-functions.html#predict-game"><i class="fa fa-check"></i><b>D.1</b> Predict individual games</a></li>
<li class="chapter" data-level="D.2" data-path="prediction-functions.html"><a href="prediction-functions.html#multi-plot"><i class="fa fa-check"></i><b>D.2</b> Plot multiple plots</a></li>
<li class="chapter" data-level="D.3" data-path="prediction-functions.html"><a href="prediction-functions.html#predict-league"><i class="fa fa-check"></i><b>D.3</b> Predict leagues</a></li>
<li class="chapter" data-level="D.4" data-path="prediction-functions.html"><a href="prediction-functions.html#predict-ucl"><i class="fa fa-check"></i><b>D.4</b> Predict Champions League</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Soccer Predictions Using Bayesian Mixed Effects Models</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="define-model" class="section level1">
<h1><span class="header-section-number">2</span> Defining the Model</h1>
<p>In soccer, the goals scored by a single team can be thought of as coming from a Poisson distribution. Thus, we can state that the two scores from a given game, <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>, are Poisson distributed.</p>
<span class="math display" id="eq:indep-pois">\[\begin{equation}
\begin{split}
  X &amp; \sim Poisson(\lambda_1)\\
  Y &amp; \sim Poisson(\lambda_2)
\end{split}
\tag{2.1}
\end{equation}\]</span>
<p>This parameterization, however, assumes that the scores <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> are independent of each other. In this project, the aim is to model the association between the two Poisson distributed variables. There are two methods for modeling this association that will be examined. The first is a bivariate Poisson distribution. The second is a mixed effects model with a random slope for each game.</p>
<div id="biv-pois" class="section level2">
<h2><span class="header-section-number">2.1</span> The bivariate Poisson model</h2>
<p>In the bivariate Poisson, the scores for teams <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span>, <span class="math inline">\(X_A\)</span> and <span class="math inline">\(X_B\)</span>, are random variables where <span class="math inline">\(G_i \sim Poisson(\lambda_i),\ i = 0,\ 1,\ 2\)</span>.</p>
<span class="math display" id="eq:bipois">\[\begin{equation}
\begin{split}
  X_A &amp; = G_1 + G_0\\
  X_B &amp; = G_2 + G_0
\end{split}
\tag{2.2}
\end{equation}\]</span>
<p>And <span class="math inline">\(X_A\)</span> and <span class="math inline">\(X_B\)</span> are jointly distributed</p>
<span class="math display" id="eq:jbp">\[\begin{equation}
  (X_A,\ X_B) \sim BP(\lambda_1,\ \lambda_2,\ \lambda_0)
\tag{2.3}
\end{equation}\]</span>
<p>In this parameterization, <span class="math inline">\(X_A\)</span> and <span class="math inline">\(X_B\)</span> are Poisson distributed with means equal to <span class="math inline">\(\lambda_1 + \lambda_3\)</span> and <span class="math inline">\(\lambda_2 + \lambda_3\)</span> respectively, with <span class="math inline">\(\lambda_3\)</span> representing the covariance between <span class="math inline">\(X_A\)</span> and <span class="math inline">\(X_B\)</span> <span class="citation">(AlMuhayfith, Alzaid, &amp; Omair, 2016; Griffiths &amp; Milne, 1978; Kawamura, 1973)</span>. We can model these parameters just as we would model, for example, means in a normal distribution. Thus, for a given game, <span class="math inline">\(i\)</span>,</p>
<span class="math display" id="eq:bipois-regress">\[\begin{equation}
\begin{split}
  (X_{Ai},\ X_{Bi}) &amp; \sim BP(\lambda_{1i},\ \lambda_{2i},\ \lambda_{0i}),\\
  log(\lambda_{1i}) &amp; = \omega_{1i}\beta_{1},\\
  log(\lambda_{2i}) &amp; = \omega_{2i}\beta_{2},\\
  log(\lambda_{0i}) &amp; = \omega_{0i}\beta_{0}
\end{split}
\tag{2.4}
\end{equation}\]</span>
<p>where <span class="math inline">\(\omega\)</span> represents a matrix of independent variable, and <span class="math inline">\(\beta\)</span> denotes the regression coefficients <span class="citation">(Karlis &amp; Ntzoufras, 2003, 2005)</span>. When predicting soccer games, the independent variables are the teams that are playing, and the regression coefficients represent the offensive or defensive strength of the teams <span class="citation">(Groll, Kneib, Mayr, &amp; Schauberger, 2016)</span>. Specifically, we can model the two scores, <span class="math inline">\(X\)</span>, for teams <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span>, from a given game, <span class="math inline">\(i\)</span>, as</p>
<span class="math display" id="eq:lambda0" id="eq:lambda2" id="eq:lambda1">\[\begin{align}
  log(X_{Ai}) &amp;= \lambda_{1i} + \lambda_{0i}, \notag \\
  log(X_{Bi}) &amp;= \lambda_{2i} + \lambda_{0i}, \notag \\
  \lambda_{1i} &amp;= \mu + \eta H_i + \alpha_A + \delta_B, \tag{2.5} \\
  \lambda_{2i} &amp;= \mu + \alpha_B + \delta_A, \tag{2.6} \\
  \lambda_{0i} &amp;= \rho_A + \rho_B \tag{2.7}
\end{align}\]</span>
<p>Here, <span class="math inline">\(\mu\)</span> denotes the overall intercept, or the expected log goals for a team not playing at home, and <span class="math inline">\(\eta\)</span> represents the increase in expected log goals for a team playing at home. <span class="math inline">\(H_i\)</span> is a dummy variable indicating whether game <span class="math inline">\(i\)</span> was played at the home team’s stadium (1) or a neutral site (0). The estimates of team ability come from <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\delta\)</span>, which represent the attacking and defensive abilities of the given team respectively. These can be modeled as fixed effects, or as random effects. Finally, <span class="math inline">\(\rho\)</span> denotes the change in expected covariance for each team <span class="citation">(Whitaker, 2011)</span>.</p>
<div id="imp-bivpois" class="section level3">
<h3><span class="header-section-number">2.1.1</span> Implementing the bivariate Poisson model</h3>
<p>The bivariate Poisson model can be fit using the following Stan code and the <strong>rstan</strong> package <span class="citation">(Guo, Gabry, &amp; Goodrich, 2017)</span>. In the model code, I have modeled <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\delta\)</span>, and <span class="math inline">\(\rho\)</span> as random effects so that <span class="math inline">\(\mu\)</span> represents the overall mean. This means that positive <span class="math inline">\(\alpha\)</span> values and negative <span class="math inline">\(\delta\)</span> are good, as team wants the attack to add goals above the average, and the defense to result in the opponent have below average goals.</p>
<p>All parameters have non-information priors. The priors were specified as normal with a mean of 0 and standard deviation of 10. This specification provides a diffuse range of plausible values for the parameter, allowing the likelihood to dominate. However, the use of a diffuse normal prior also prevents arbitrary boundaries from being set for a uniformly distributed prior.</p>
<p>I have also reparameterized the random effects so that Stan can sample from a <span class="math inline">\(\mathcal{N}(0,\ 1)\)</span>, which reduces computation time and increases the efficiency of the sampler to avoid divergent transitions <span class="citation">(Betancourt, 2016, 2017; Stan Development Team, 2016c)</span>.</p>
<pre class="stan"><code>data {
  int&lt;lower=1&gt; num_clubs;                           // number of clubs
  int&lt;lower=1&gt; num_games;                           // number of games
  int&lt;lower=1,upper=num_clubs&gt; home[num_games];     // home club for game g
  int&lt;lower=1,upper=num_clubs&gt; away[num_games];     // away club for game g
  int&lt;lower=0&gt; h_goals[num_games];                  // home goals for game g
  int&lt;lower=0&gt; a_goals[num_games];                  // away goals for game g
  int&lt;lower=0,upper=1&gt; homeg[num_games];            // home field for game g
}
parameters {
  vector[num_clubs] raw_alpha;                  // attacking intercepts
  vector[num_clubs] raw_delta;                  // defending intercepts
  vector[num_clubs] raw_rho;                    // covariance intercepts

  real mu;                                          // fixed intercept
  real eta;                                         // homefield
  real&lt;lower=0&gt; sigma_a;                            // attacking sd
  real&lt;lower=0&gt; sigma_d;                            // defending sd
  real&lt;lower=0&gt; sigma_r;                            // covariance sd
}
transformed parameters {
  vector[num_clubs] alpha;
  vector[num_clubs] delta;
  vector[num_clubs] rho;
  
  alpha = raw_alpha * sigma_a;
  delta = raw_delta * sigma_d;
  rho = raw_rho * sigma_r;
}
model {
  vector[num_games] lambda1;
  vector[num_games] lambda2;
  vector[num_games] lambda3;

  // priors
  raw_alpha ~ normal(0, 1);
  raw_delta ~ normal(0, 1);
  raw_rho ~ normal(0, 1);
  mu ~ normal(0, 10);
  eta ~ normal(0, 10);
  sigma_a ~ normal(0, 10);
  sigma_d ~ normal(0, 10);
  sigma_r ~ normal(0, 10);

  // likelihood
  for (g in 1:num_games) {
    lambda1[g] = exp(mu + (eta * homeg[g]) + alpha[home[g]] + delta[away[g]]);
    lambda2[g] = exp(mu + alpha[away[g]] + delta[home[g]]);
    lambda3[g] = exp(rho[home[g]] + rho[away[g]]);
  }
  h_goals ~ poisson(lambda1 + lambda3);
  a_goals ~ poisson(lambda2 + lambda3);
}</code></pre>
</div>
</div>
<div id="gri" class="section level2">
<h2><span class="header-section-number">2.2</span> The game random intercept model</h2>
<p>As an alternative to the bivariate Poisson model, one could model a random intercept for each game, rather than estimating <span class="math inline">\(\rho\)</span>. Thus, the game random intercept model would be defined as</p>
<span class="math display" id="eq:grilam2" id="eq:grilam1">\[\begin{align}
  log(X_{Ai}) &amp;= \lambda_{1i}, \notag \\
  log(X_{Bi}) &amp;= \lambda_{2i}, \notag \\
  \lambda_{1i} &amp;= \mu + \eta H_i + \alpha_A + \delta_B + \gamma_i, \tag{2.8} \\
  \lambda_{2i} &amp;= \mu + \alpha_B + \delta_A + \gamma_i \tag{2.9}
\end{align}\]</span>
<p>This model is very similar to the bivariate Poisson. The two rate parameters, <span class="math inline">\(\lambda_{1i}\)</span> and <span class="math inline">\(\lambda_{2i}\)</span>, are defined the same, with only the addition of <span class="math inline">\(\gamma_i\)</span> denoting the random intercept for the game. This <span class="math inline">\(\gamma_i\)</span> replaces <span class="math inline">\(\lambda_{0i}\)</span> in the bivariate Poisson model. This has a couple of downstream effects on the estimation.</p>
<p>First, in the bivariate Poisson model, <span class="math inline">\(\rho\)</span> is estimated for each team. Thus the convariance, <span class="math inline">\(\lambda_{0i}\)</span> is predicted for each game by the competing teams’ <span class="math inline">\(\rho\)</span> values. This also allows predictions to be made for future games about what the covariance or dependency between the teams will be. In contrast, game random intercept model doesn’t estimate predictors for this dependency. In this model, the dependency is treated as a random variable, with some variance to be estimated.</p>
<p>Thus, although both models take into account the dependency between the two scores in a given game, the models make different assumptions about the nature of this dependency.</p>
<div id="imp-gri" class="section level3">
<h3><span class="header-section-number">2.2.1</span> Implementing the game random intercept model</h3>
<p>The game random intercept model can be estimated using the following Stan code and the <strong>rstan</strong> package <span class="citation">(Guo et al., 2017)</span>. As with the bivariate Poisson model, I have modeled <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\delta\)</span> as random effects so that <span class="math inline">\(\mu\)</span> represents the overall mean. Diffuse normal priors are specified in the same way as for the bivariate Poisson model. The random effects are also reparameterized in the same way as they were in the bivariate Poisson to reduce computation time and increase efficiency <span class="citation">(Betancourt, 2016, 2017; Stan Development Team, 2016c)</span>.</p>
<pre class="stan"><code>data {
  int&lt;lower=1&gt; num_clubs;                           // number of clubs
  int&lt;lower=1&gt; num_games;                           // number of games
  int&lt;lower=1,upper=num_clubs&gt; home[num_games];     // home club for game g
  int&lt;lower=1,upper=num_clubs&gt; away[num_games];     // away club for game g
  int&lt;lower=0&gt; h_goals[num_games];                  // home goals for game g
  int&lt;lower=0&gt; a_goals[num_games];                  // away goals for game g
  int&lt;lower=0,upper=1&gt; homeg[num_games];            // home field for game g
}
parameters {
  vector[num_clubs] raw_alpha;                      // attacking intercepts
  vector[num_clubs] raw_delta;                      // defending intercepts
  vector[num_games] raw_gamma;                      // game intercepts

  real mu;                                          // fixed intercept
  real eta;                                         // homefield
  real&lt;lower=0&gt; sigma_a;                            // attacking sd
  real&lt;lower=0&gt; sigma_d;                            // defending sd
  real&lt;lower=0&gt; sigma_g;                            // game sd
}
transformed parameters {
  vector[num_clubs] alpha;
  vector[num_clubs] delta;
  vector[num_games] gamma;

  alpha = sigma_a * raw_alpha;
  delta = sigma_d * raw_delta;
  gamma = sigma_g * raw_gamma;
}
model {
  vector[num_games] lambda1;
  vector[num_games] lambda2;

  // priors
  raw_alpha ~ normal(0, 1);                         // attacking random effects
  raw_delta ~ normal(0, 1);                         // defending random effects
  raw_gamma ~ normal(0, 1);                         // game random effects
  mu ~ normal(0, 10);
  eta ~ normal(0, 10);
  sigma_a ~ normal(0, 10);
  sigma_d ~ normal(0, 10);
  sigma_g ~ normal(0, 10);

  // likelihood
  for (g in 1:num_games) {
    lambda1[g] = exp(mu + (eta * homeg[g]) + alpha[home[g]] + delta[away[g]] + gamma[g]);
    lambda2[g] = exp(mu + alpha[away[g]] + delta[home[g]] + gamma[g]);
  }
  h_goals ~ poisson(lambda1);
  a_goals ~ poisson(lambda2);
}</code></pre>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="intro.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="simulation.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": true,
"weibo": false,
"instapper": false,
"vk": false,
"all": null
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/wjakethompson/soccer/edit/master/define-model.Rmd",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
